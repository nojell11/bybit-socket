<script>
  const ws = new WebSocket(`wss://${window.location.host}/`);
  ws.onopen = () => console.log('Connected to server');
  ws.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      const { prices } = data || {};
      
      // Safe check before accessing price
      if (prices?.coinbase?.price !== undefined) {
        document.getElementById('cb-price').textContent = `$${prices.coinbase.price.toLocaleString()}`;
      }
      if (prices?.kraken?.price !== undefined) {
        document.getElementById('kr-price').textContent = `$${prices.kraken.price.toLocaleString()}`;
      }
      updateTable(prices);
    } catch (e) {
      console.error('Parse error:', e, event.data);
    }
  };

  function updateTable(prices) {
    const tbody = document.getElementById('table-body');
    let html = '';
    if (prices?.coinbase?.price !== undefined) {
      html += `<tr><td>Coinbase</td><td>$${prices.coinbase.price.toLocaleString()}</td><td>${new Date(prices.coinbase.ts).toLocaleTimeString()}</td></tr>`;
    }
    if (prices?.kraken?.price !== undefined) {
      html += `<tr><td>Kraken</td><td>$${prices.kraken.price.toLocaleString()}</td><td>${new Date(prices.kraken.ts).toLocaleTimeString()}</td></tr>`;
    }
    tbody.innerHTML = html || '<tr><td colspan="3">Waiting for ticks...</td></tr>';
  }
</script>
